<!DOCTYPE html>
<html lang="en">
<head>
    <title>AeroViewer - ICAO TACTICAL V1.1</title>
    <meta charset="utf-8">
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, user-scalable=yes">
    <meta name="theme-color" content="#0d1117">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.4.0/model-viewer.min.js"></script>
    <style>
        :root {
            --app-bg: #0d1117; --raf-blue: #5d7a8c; --raf-red: #c21807;
            --icao-gold: #d4af37; --accent: #63b3ed; --glass: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --rotary-green: #48bb78; --tactical-yellow: #ffd700;
        }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background-color: var(--app-bg); font-family: 'Segoe UI', Roboto, sans-serif; touch-action: pan-x pan-y; }
        
        #start-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at center, #1a202c 0%, #0d1117 100%); z-index: 2000; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.6s ease; }
        .radar { position: relative; width: 280px; height: 280px; border: 2px solid rgba(99, 179, 237, 0.2); border-radius: 50%; margin-bottom: 20px;}
        .radar::after { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 50%; background: conic-gradient(from -90deg, transparent 0deg, rgba(99, 179, 237, 0.4) 90deg, transparent 91deg); animation: sweep 4s linear infinite; }
        @keyframes sweep { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .commence-btn { background: transparent; color: white; border: 1px solid white; padding: 15px 45px; border-radius: 4px; letter-spacing: 4px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .commence-btn:hover { background: white; color: black; }
        
        #pdf-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.98); z-index: 3000; display: none; flex-direction: column; }
        #pdf-modal.active { display: flex; }
        .pdf-header { background: var(--app-bg); padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--glass-border); }
        .pdf-title { color: white; font-size: 14px; font-weight: 700; text-transform: uppercase; }
        .pdf-close-btn { background: var(--raf-red); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 800; }
        .pdf-container { flex: 1; overflow: hidden; position: relative; background: #2a2a2a; }
        .pdf-scroll-container { width: 100%; height: 100%; overflow: auto; -webkit-overflow-scrolling: touch; }
        #pdf-canvas { display: block; margin: 0 auto; box-shadow: 0 4px 20px rgba(0,0,0,0.5); }
        .pdf-controls-bar { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(10px); padding: 10px 15px; border-radius: 30px; display: flex; gap: 15px; align-items: center; z-index: 10; }
        .pdf-control-btn { background: var(--glass); border: 1px solid var(--glass-border); color: white; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; }
        
        .app-overlay { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); z-index: 100; width: 95%; max-width: 600px; pointer-events: none; }
        .control-panel { background: var(--glass); backdrop-filter: blur(20px); border: 1px solid var(--glass-border); padding: 12px 18px; border-radius: 14px; pointer-events: auto; }
        #asset-search { background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); color: white; width: 100%; padding: 12px; border-radius: 6px; margin-bottom: 10px; box-sizing: border-box; }
        .filter-row { display: flex; gap: 5px; margin-bottom: 10px; overflow-x: auto; }
        .filter-btn { background: rgba(255,255,255,0.1); color: #ccc; border: none; padding: 6px 12px; border-radius: 4px; font-size: 10px; font-weight: 700; cursor: pointer; text-transform: uppercase; }
        .filter-btn.active { background: var(--accent); color: white; }
        .selector-row { display: flex; justify-content: space-between; align-items: center; gap: 10px; }
        .panel-label { font-size: 10px; color: var(--accent); text-transform: uppercase; font-weight: 800; }
        select { background: transparent; color: white; border: none; font-weight: bold; width: 100%; cursor: pointer; outline: none; }
        
        .details-panel { position: absolute; top: 0; right: -100%; width: 100%; max-width: 500px; height: 100%; background: rgba(10, 15, 25, 0.98); backdrop-filter: blur(30px); z-index: 300; transition: right 0.4s cubic-bezier(0.19, 1, 0.22, 1); color: white; overflow-y: auto; }
        .details-panel.active { right: 0; }
        .details-inner { padding: 60px 40px; }
        .spec-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .spec-item { border-top: 1px solid var(--glass-border); padding: 15px 0; }
        .full-width { grid-column: span 2; }
        .spec-label { font-size: 11px; color: var(--accent); text-transform: uppercase; }
        .spec-value { display: block; font-size: 18px; margin-top: 6px; font-family: 'Courier New', monospace; }
        
        model-viewer { width: 100vw; height: 100vh; background-color: #1a202c; }
        .tactical-vehicle { width: 100px; height: 100px; pointer-events: none; overflow: visible; }
        .tactical-model { width: 100%; height: 100%; --min-hotspot-opacity: 0; }
        .hotspot-annotation { background: var(--raf-red); color: white; border-radius: 4px; font-size: 10px; font-weight: bold; padding: 4px 8px; position: absolute; white-space: nowrap; pointer-events: none; transform: translateY(-40px); text-align: center; }
        .factsheet-btn { background: var(--raf-blue); color: white; border: none; padding: 10px 16px; border-radius: 6px; font-size: 11px; font-weight: 800; cursor: pointer; }
        .manual-btn { background: var(--icao-gold); color: #000; border: none; padding: 10px 16px; border-radius: 6px; font-size: 11px; font-weight: 800; cursor: pointer; display: none; }
    </style>
</head>
<body>
    <div id="start-screen">
        <div class="radar"></div>
        <div style="text-align:center;">
            <h1 style="color:white; letter-spacing:8px; font-weight:200;">AERO VIEWER</h1>
            <p style="color: var(--accent); font-size: 10px; letter-spacing: 2px; margin-bottom: 30px;">DFRP VR Team V1.1</p>
            <button class="commence-btn" onclick="enterApp()">START VIEWER</button>
        </div>
    </div>

    <div id="pdf-modal">
        <div class="pdf-header">
            <div class="pdf-title" id="pdf-modal-title">TTP Viewer</div>
            <button class="pdf-close-btn" onclick="closePdfModal()">✕ CLOSE</button>
        </div>
        <div class="pdf-container">
            <div class="pdf-scroll-container">
                <canvas id="pdf-canvas"></canvas>
            </div>
            <div class="pdf-controls-bar">
                <button class="pdf-control-btn" onclick="previousPage()">◀</button>
                <div id="pdf-page-info" style="color:white; font-size:12px;">1 / 1</div>
                <button class="pdf-control-btn" onclick="nextPage()">▶</button>
            </div>
        </div>
    </div>

    <div id="details-panel" class="details-panel">
        <div class="details-inner">
            <div id="asset-classification" class="spec-label">Syncing...</div>
            <h2 id="asset-title" style="margin: 15px 0; font-size: 32px; text-transform: uppercase;">Asset</h2>
            <div id="spec-container" class="spec-grid"></div>
            <button onclick="toggleDetails()" style="margin-top: 50px; background: white; border: none; color: black; padding: 18px; width: 100%; cursor: pointer; font-weight: 800; text-transform: uppercase;">Close window</button>
        </div>
    </div>

    <div class="app-overlay">
        <div class="control-panel">
            <input type="text" id="asset-search" placeholder="Search Database...">
            <div class="filter-row">
                <button class="filter-btn active" onclick="filterByType('all')">All</button>
                <button class="filter-btn" onclick="filterByType('civilian')">Civilian</button>
                <button class="filter-btn" onclick="filterByType('military')">Military</button>
            </div>
            <div class="selector-row">
                <div style="flex-grow: 1; overflow: hidden; padding-right: 10px;">
                    <span class="panel-label">Primary Asset</span>
                    <select id="model-select"></select>
                </div>
                <button id="pdf-btn" class="manual-btn" onclick="openPdfModal()">TTP</button>
                <button class="factsheet-btn" onclick="toggleDetails()">Factsheet</button>
            </div>
            <div class="selector-row" style="margin-top: 10px;">
                <div style="flex-grow: 1;">
                    <span class="panel-label">Tactical Scenario</span>
                    <select id="scenario-select">
                        <option value="none">Standard View</option>
                        <option value="engine_fire">TTP 1 - Engine Fire</option>
                        <option value="wheel_fire">TTP 2 - Wheel Assembly</option>
                        <option value="internal_fire">TTP 3 - Internal Fire</option>
                        <option value="external_fire">TTP 4 - External Fire</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <model-viewer id="main-viewer" ar ar-modes="webxr scene-viewer quick-look" camera-controls auto-rotate shadow-intensity="2"></model-viewer>

    <script>
        const tacticalDeployments = {
            "A400M Atlas": {
                "engine_fire": [
                    { type: "mprv", position: "15m 0m 20m", rotation: "0deg 45deg 0deg", label: "Crash 1: MPRV" },
                    { type: "striker", position: "-25m 0m 10m", rotation: "0deg -45deg 0deg", label: "Crash 2: Striker" }
                ]
            },
            "C-17A Globemaster": {
                "engine_fire": [
                    { type: "mprv", position: "18m 0m 15m", rotation: "0deg 45deg 0deg", label: "Crash 1: MPRV" },
                    { type: "striker", position: "-30m 0m 20m", rotation: "0deg -45deg 0deg", label: "Crash 2: Striker" },
                    { type: "striker", position: "0m 0m -35m", rotation: "0deg 180deg 0deg", label: "Crash 3: Striker" }
                ],
                "wheel_fire": [
                    { type: "mprv", position: "20m 0m 0m", rotation: "0deg 90deg 0deg", label: "Crash 1: MPRV" },
                    { type: "striker", position: "-25m 0m 5m", rotation: "0deg -90deg 0deg", label: "Crash 2: Striker" }
                ]
            }
        };

        const rawData = [
            { name: "A400M Atlas", type: "military", file: "A400M", ios_file: "a400m", mtow: "141t", span: "42.4m", crew: "3", pax: "116", danger: "Propellers", note: "Tactical heavy.", pdf: "ATTP-A01-A400M-(Pax)-V1.2.pdf" },
            { name: "C-17A Globemaster", type: "military", file: "c17a", ios_file: "C17A", mtow: "265t", span: "51.7m", crew: "3", pax: "102", danger: "Reverse thrust", note: "Strategic lifter.", pdf: "ATTP-A06-C17-(Cargo)-V1.2.pdf" },
            { name: "Airbus A320", type: "civilian", file: "airbus_a320", ios_file: "Airbus_A320", mtow: "78t", span: "35.8m", crew: "2", pax: "186", danger: "Eng Intake", pdf: "A320.pdf" }
        ];

        const modelData = rawData.sort((a, b) => a.name.localeCompare(b.name));
        const viewer = document.querySelector('#main-viewer');
        const modelSelect = document.querySelector('#model-select');
        const scenarioSelect = document.querySelector('#scenario-select');
        const pdfBtn = document.getElementById('pdf-btn');
        let currentAssetName = "";

        function enterApp() {
            document.getElementById('start-screen').style.opacity = '0';
            setTimeout(() => document.getElementById('start-screen').style.display = 'none', 600);
        }

        function populateSelect() {
            modelSelect.innerHTML = '';
            modelData.forEach((m, idx) => {
                const opt = document.createElement('option');
                opt.value = idx;
                opt.textContent = m.name;
                modelSelect.appendChild(opt);
            });
        }

        function updateAsset(idx) {
            const asset = modelData[idx];
            currentAssetName = asset.name;
            viewer.src = `models/${asset.file}.glb`;
            pdfBtn.style.display = asset.pdf ? "block" : "none";
            document.getElementById('asset-title').textContent = asset.name;
            document.getElementById('spec-container').innerHTML = `
                <div class="spec-item"><span class="spec-label">MTOW</span><span class="spec-value">${asset.mtow}</span></div>
                <div class="spec-item"><span class="spec-label">Span</span><span class="spec-value">${asset.span}</span></div>
            `;
            scenarioSelect.value = "none";
            renderTacticalScenario("none");
        }

        function renderTacticalScenario(scenarioId) {
            document.querySelectorAll('.tactical-vehicle').forEach(el => el.remove());
            if (scenarioId === "none") return;

            const assetData = tacticalDeployments[currentAssetName];
            if (!assetData || !assetData[scenarioId]) return;

            assetData[scenarioId].forEach((v, i) => {
                const hotspot = document.createElement('div');
                hotspot.className = 'hotspot tactical-vehicle visible';
                hotspot.slot = `hotspot-tactical-${i}`;
                hotspot.dataset.position = v.position;
                hotspot.dataset.normal = "0 1 0";

                hotspot.innerHTML = `
                    <model-viewer class="tactical-model" src="models/${v.type}.glb" 
                        interaction-prompt="none" scale="0.25 0.25 0.25" orientation="${v.rotation}">
                    </model-viewer>
                    <div class="hotspot-annotation">${v.label}</div>
                `;
                viewer.appendChild(hotspot);
            });
        }

        function toggleDetails() { document.getElementById('details-panel').classList.toggle('active'); }

        modelSelect.addEventListener('change', (e) => updateAsset(e.target.value));
        scenarioSelect.addEventListener('change', (e) => renderTacticalScenario(e.target.value));

        window.onload = () => {
            populateSelect();
            updateAsset(0);
        };
    </script>
</body>
</html>
